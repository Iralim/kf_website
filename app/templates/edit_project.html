{% extends 'base.html' %}
{% block title %}Admin{% endblock %}

{% block styles %} 
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_edit_project.css') }}">

{% endblock %}

{% block hero %}{% endblock %}
{% block features %}{% endblock %}


{% block content %}
<section class="py-5">
  <div class="container">
    <form method="POST" action="{{ url_for('main.edit_project', id=project.id) }}" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <div class="row g-4 align-items-start">
        <!-- Основной текст + поля ввода -->
        <div class="col-lg-8">
          <!-- Название дома -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="font-family: 'Oswald', sans-serif;">Название проекта</label>
            {{ form.title(class="form-control form-control-lg") }}
          </div>

          <!-- Описание -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="font-family: 'Oswald', sans-serif;">Описание</label>
            {{ form.description(class="form-control", rows="4") }}
          </div>
          <!-- Upload Image -->
           <div class="mb-4">
            <!-- <label class="form-label fw-bold" style="font-family: 'Oswald', sans-serif;">Загрузка Изображений</label>
            {{ form.img_files(class="form-control", rows="4", multiple=True) }} -->
            
            <label class="form-label fw-bold">Загрузка Изображений</label>
{{ form.img_files(class="form-control", multiple=True, id="imgUpload") }}

<script>
const existingFiles = {{ existing_files|tojson }};
const uploadInput = document.getElementById("imgUpload");

uploadInput.addEventListener("change", function () {
    const selectedFiles = Array.from(this.files);

    // 1) Проверяем дубликаты среди уже существующих файлов
    const duplicatesWithExisting = selectedFiles.filter(file =>
        existingFiles.includes(file.name)
    );

    if (duplicatesWithExisting.length > 0) {
        alert("Файлы уже существуют: \n" +
              duplicatesWithExisting.map(f => f.name).join("\n"));
        this.value = ""; // очищаем поле загрузки
        return;
    }

    // 2) Проверяем дубликаты среди загруженных файлов
    const names = selectedFiles.map(f => f.name);
    const duplicatesInsideUpload = names.filter((name, index) =>
        names.indexOf(name) !== index
    );

    if (duplicatesInsideUpload.length > 0) {
        alert("Нельзя загружать два файла с одинаковыми именами:\n" +
              duplicatesInsideUpload.join("\n"));
        this.value = ""; // очищаем поле
        return;
    }
});
</script>

          </div>
         <!-- Mini-галерея -->
<div class="mb-4">
    <div class="card border-0 shadow p-3">
        <div class="gallery-grid">
          {% for image in images %}
          <div class="gallery-item" data-id="{{ image.id }}">
    <img src="{{ url_for('static', filename=image.url) }}" alt="image">
    <button class="delete-btn" data-id="{{ image.id }}">✕</button>
</div>

          {% endfor %}

<script>
// Универсальный fetch с обработкой ошибок
async function safeFetch(url, options = {}) {
    try {
        const response = await fetch(url, {
            headers: { "X-Requested-With": "XMLHttpRequest" },
            ...options
        });

        if (!response.ok) {
            throw new Error("Server error: " + response.status);
        }

        return response;
    } catch (err) {
        console.error(err);
        throw err;
    }
}

document.addEventListener("click", async function(event) {
    const btn = event.target.closest(".delete-btn");
    if (!btn) return;

    const id = btn.dataset.id;
    const item = btn.closest(".gallery-item");

    if (!confirm("Удалить изображение?")) return;

    btn.disabled = true;

    try {
        // DELETE запрос
        await safeFetch(`/delete_image/${id}`, { method: "DELETE" });

        // Анимация исчезновения
        item.classList.add("removing");

        // Удаляем после анимации
        setTimeout(() => item.remove(), 300);

    } catch (err) {
        alert("Ошибка удаления");
        btn.disabled = false;
    }
});
</script>


        </div>
    </div>
</div>

        </div>

        <!-- Характеристики -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm p-4">
            <h5 class="fw-bold mb-3" style="font-family: 'Oswald', sans-serif;">Характеристики</h5>

            <div class="mb-3">
              <label class="form-label">Площадь (м²)</label>
              {{ form.square(class="form-control") }}
            </div>

            <div class="mb-3">
              <label class="form-label">Площадь участка (м²)</label>
              {{ form.size(class="form-control") }}
            </div>

            <div class="mb-3">
              <label class="form-label">Базовая цена (тёплый контур)</label>
              {{ form.price_base(class="form-control") }}
            </div>

            <div class="mb-3">
              <label class="form-label">Цена с коммуникациями</label>
              {{ form.price_with_communications(class="form-control") }}
            </div>

            <div class="mb-3">
              <label class="form-label">Цена готового дома</label>
              {{ form.price_ready(class="form-control") }}
            </div>

            <div class="mb-3">
              <label class="form-label">Ипотека (в месяц)</label>
              {{ form.mortgage_price_per_month(class="form-control") }}
            </div>
          </div>
        </div>
    </div>
      
      
       
    
       

      <!-- Кнопка отправки -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="d-grid">
            {{ form.submit(class="btn btn-success btn-lg") }}
          </div>
        </div>
      </div>
    </form>
  </div>
</section>

<section id="projects" class="py-5 bg-light">
  <div class="container text-center">

    <div class="row g-4">

      {% for project in projects %}
      <div class="col-md-6 col-lg-4">
        <a href="{{ url_for('main.edit_project', id=project.id) }}" class="text-decoration-none text-reset">
          <div class="card project-card border-0 shadow-sm h-100 overflow-hidden">

            <!-- Слайдер с уникальным ID -->
            <!-- <div id="carouselProject{{ project.id }}" class="carousel slide project-image-wrapper" data-bs-ride="carousel" data-bs-interval="7000"> -->
            <div id="carouselPoject{{ project.id }}" class="carousel slide project-image-wrapper">
              <div class="carousel-inner">
                {% for image in project.images.all() %}
                <div class="carousel-item active">
                  <img src="{{ url_for('static', filename=image.image_url) }}" class="card-img-top" alt="Проект дома {{ project.title }}">
                </div>
                {% endfor %}
              </div>

              <!-- Стрелки -->
              <button class="carousel-control-prev" type="button" data-bs-target="#carouselProject{{ project.id }}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carouselProject{{ project.id }}" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>

            <div class="card-body text-start p-4">
              <h5 class="card-title fw-semibold mb-3" style="font-family: 'Oswald', sans-serif; color: #2d2d2d;">
                {{ project.title }}
              </h5>

              <table class="table table-borderless text-secondary small mb-0 compact-table">
                <tbody>
                  <tr>
                    <th scope="row">Тёплый контур:</th>
                    <td class="text-end text-dark fw-normal">{{ project.price_base | money }} &#8381;</td>
                  </tr>
                  <tr>
                    <th scope="row">С коммуникациями:</th>
                    <td class="text-end text-dark fw-normal">{{ project.price_with_communications | money }} &#8381;</td>
                  </tr>
                  <tr>
                    <th scope="row">Заезжай и живи:</th>
                    <td class="text-end text-dark fw-normal">{{ project.price_ready | money }} &#8381;</td>
                  </tr>
                  <tr class="border-top">
                    <th scope="row" class="pt-2">Ипотека от:</th>
                    <td class="text-end fw-semibold pt-2">{{ project.mortgage_price_per_month | money }} &#8381;/мес</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </a>
      </div>
      {% endfor %}

    </div>
  </div>
</section>
{% endblock %}
