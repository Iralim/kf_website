{% extends 'base.html' %}
{% block title %}Admin{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_cards.css') }}">
{% endblock %}

{% block header %}
<div class="fixed-top">

  <!-- üîπ –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="topbar py-1 bg-secondary">
    <div class="container d-flex flex-wrap align-items-center justify-content-between">
      <div class="text-white">
        üìû <a href="tel:+79173755545" class="text-white text-decoration-none">+7 (917) 37-555-45</a>
      </div>

      <div class="d-flex gap-2">
        <a href="https://t.me/username" target="_blank" class="social-btn text-white" aria-label="Telegram">
          <i class="fab fa-telegram"></i>
        </a>
        <a href="https://vk.com/username" target="_blank" class="social-btn text-white" aria-label="VK">
          <i class="fab fa-vk"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- üîπ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <nav class="navbar navbar-expand-md navbar-light bg-white border-bottom py-3" id="mainNav">
    <div class="container">

      <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
        <img src="{{ url_for('static', filename='images/logo_krepkii_fundament.png')}}" alt="Logo" width="300">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="mainNavbar">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" href="#projects">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></li>
        </ul>

        <div class="d-md-none text-center mt-3">
          <a href="tel:+79173755545" class="btn btn-outline-primary">üìû +7 (917) 37-555-45</a>
          <p class="text-secondary mb-0">–ü–Ω‚Äì–ü—Ç: —Å 9:00 –¥–æ 18:00</p>
        </div>
      </div>

    </div>
  </nav>

</div>
{% endblock %}

{% block hero %}{% endblock %}
{% block features %}{% endblock %}

{% block content %}

<!-- ============================
       –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
============================= -->
<section class="py-5">
  <div class="container">
    <form method="POST" action="{{ url_for('main.add_project') }}" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <div class="row g-4">

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å -->
        <div class="col-lg-8">

          <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
          <div class="mb-4">
            <label class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
            {{ form.title(class="form-control form-control-lg") }}

            <div id="title-check-msg" class="small mt-2"></div>
          </div>

          <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
          <div class="mb-4">
            <label class="form-label fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            {{ form.description(class="form-control", rows="4") }}
          </div>

          <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
          <div class="mb-4">
            <label class="form-label fw-bold">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</label>
            {{ form.img_files(class="form-control", multiple=True) }}
          </div>

        </div>

        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm p-4">

            <h5 class="fw-bold mb-3">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h5>

            <div class="mb-3">
              <label class="form-label">–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
              {{ form.square(class="form-control") }}
            </div>
            <div class="mb-3">
              <label class="form-label">–ì–∞–±–∞—Ä–∏—Ç—ã (–¥–ª–∏–Ω–∞ √ó —à–∏—Ä–∏–Ω–∞)</label>
              {{ form.size(class="form-control") }}
            </div>
            <div class="mb-3">
              <label class="form-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞</label>
              {{ form.price_base(class="form-control") }}
            </div>
            <div class="mb-3">
              <label class="form-label">–¶–µ–Ω–∞ —Å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏</label>
              {{ form.price_with_communications(class="form-control") }}
            </div>
            <div class="mb-3">
              <label class="form-label">–¶–µ–Ω–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –¥–æ–º–∞</label>
              {{ form.price_ready(class="form-control") }}
            </div>
            <div class="mb-3">
              <label class="form-label">–ò–ø–æ—Ç–µ–∫–∞ (–≤ –º–µ—Å—è—Ü)</label>
              {{ form.mortgage_price_per_month(class="form-control") }}
            </div>

          </div>
        </div>
      </div>

      <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ -->
      <div class="row mt-4">
        <div class="col-6">
          <div class="d-grid">
            {{ form.submit(class="btn btn-success btn-lg") }}
          </div>
        </div>
      </div>

    </form>
  </div>
</section>

<!-- ============================
          –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
============================= -->
<section id="projects" class="py-5 bg-light">
  <div class="container">

    <div class="row g-4">

      {% for project in projects %}
      <div class="col-md-6 col-lg-4">

        <a href="{{ url_for('main.edit_project', id=project.id) }}" class="text-decoration-none text-reset">
          <div class="card project-card border-0 shadow-sm h-100">

            <!-- –ö–∞—Ä—É—Å–µ–ª—å -->
            <div id="carousel{{ project.id }}" class="carousel slide">
              <div class="carousel-inner">
                {% for image in project.images.all() %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                  <img src="{{ url_for('static', filename=image.url) }}" class="card-img-top" alt="{{ project.title }}">
                </div>
                {% endfor %}
              </div>

              <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ project.id }}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ project.id }}" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>

            <div class="card-body p-4">
              <h5 class="fw-semibold mb-3">{{ project.title }}</h5>

              <table class="table table-borderless text-secondary small mb-0">
                <tbody>
                  <tr>
                    <th>–¢—ë–ø–ª—ã–π –∫–æ–Ω—Ç—É—Ä:</th>
                    <td class="text-end text-dark">{{ project.price_base | money }} ‚ÇΩ</td>
                  </tr>
                  <tr>
                    <th>–° –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏:</th>
                    <td class="text-end text-dark">{{ project.price_with_communications | money }} ‚ÇΩ</td>
                  </tr>
                  <tr>
                    <th>–ì–æ—Ç–æ–≤—ã–π –¥–æ–º:</th>
                    <td class="text-end text-dark">{{ project.price_ready | money }} ‚ÇΩ</td>
                  </tr>
                  <tr class="border-top">
                    <th class="pt-2">–ò–ø–æ—Ç–µ–∫–∞:</th>
                    <td class="text-end fw-semibold pt-2">{{ project.mortgage_price_per_month | money }} ‚ÇΩ/–º–µ—Å</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </a>

        <button class="btn btn-danger btn-sm delete-btn mt-2" data-id="{{ project.id }}">DELETE</button>

      </div>
      {% endfor %}

    </div>
  </div>
</section>


<!-- ============================
               JS
============================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è */
  const titleInput = document.querySelector("input[name='title']");
  const msg = document.getElementById("title-check-msg");
  let timer = null;

  if (titleInput) {
    titleInput.addEventListener("input", () => {
      clearTimeout(timer);

      timer = setTimeout(async () => {
        const title = titleInput.value.trim();
        if (!title) {
          msg.textContent = "";
          return;
        }

        const response = await fetch(`/check_title?title=${encodeURIComponent(title)}`);
        const data = await response.json();

        msg.innerHTML = data.exists
          ? "<span class='text-danger'>–ü—Ä–æ–µ–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>"
          : "<span class='text-success'>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ</span>";
      }, 350);
    });
  }

  /* –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ */
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".delete-btn");
    if (!btn) return;

    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) return;

    const id = btn.dataset.id;
    const response = await fetch(`/api/project/${id}`, { method: "DELETE" });

    if (response.ok) {
      btn.closest(".col-md-6.col-lg-4").remove();
    } else {
      alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  });

});
</script>

{% endblock %}
