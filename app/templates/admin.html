{% extends 'base.html' %}

{% block head %}
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Добавить проект{% endblock %}</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet" />
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon_io/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon_io/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon_io/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='favicon_io/site.webmanifest') }}">
    <!-- Style     -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base/main_base.css') }}">

    <!-- PAGE LEVEL STYLES -->
{% block page_style %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/add_project/main_add_project.css') }}">
{% endblock %}

    
{% endblock %}


    {% block navbar %} 
        <nav class="navbar navbar-expand-lg fixed-top">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('main.index') }}">КРЕПКИЙ <span>ФУНДАМЕНТ</span></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <i class="bi bi-list"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#add-project">Добавить проект</a></li>
                        <li class="nav-item"><a class="nav-link" href="#projects">Редактироать</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Выход</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    {% endblock %}


<!-- SECTIONS -->
{% block sections %}
    <section id="add-project" class="add-project-section">
        <div class="container">
           
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="fw-bold">Панель управления проектами</h1>
            </div>

            <!-- ФОРМА ДОБАВЛЕНИЯ ПРОЕКТА -->
            <form method="POST" action="{{ url_for('admin.add_project') }}" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="row g-4 align-items-start">
                    <!-- Основной контент -->
                    <div class="col-lg-8">
                        <!-- Основная информация -->
                        <div class="add_project-card">
                            <h3 class="section-title">Основная информация</h3>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Название проекта</label>
                                {{ form.title(class="form-control form-control-lg", placeholder="Введите название проекта") }}
                                <div id="title-check-msg" class="small mt-2"></div>
                            </div>
                            <div class="mb-0">
                                <label class="form-label fw-bold">Описание проекта</label>
                                {{ form.description(class="form-control", rows="5", placeholder="Опишите особенности проекта...") }}
                            </div>
                        </div>
                        <!-- Изображения проекта -->
                        <div class="add_project-card">
                            <h3 class="section-title">Изображения проекта</h3>
                            <div class="mb-4">
                                <label class="form-label fw-bold">Добавить изображения</label>
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">
                                        <i class="bi bi-cloud-arrow-up"></i>
                                    </div>
                                    <p class="mb-2 fw-medium">Перетащите изображения сюда или нажмите для выбора</p>
                                    <p class="text-muted small">Поддерживаются форматы JPG, PNG, GIF</p>
                                    <div class="file-input-wrapper">
                                        {{ form.img_files(multiple=True, id="imgUpload", class="form-control") }}
                                        <button type="button" class="btn btn-primary-custom mt-2" id="uploadTrigger">Выбрать файлы</button>
                                    </div>
                                </div>
                                <div class="selected-files" id="selectedFiles">
                                    <h6 class="fw-bold mb-3">Выбранные файлы:</h6>
                                    <div class="file-list" id="fileList"></div>
                                    <button type="button" class="btn btn-outline-danger btn-sm mt-3" id="clearFiles">Очистить список</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Характеристики -->
                    <div class="col-lg-4">
                        <div class="add_project-card">
                            <h3 class="section-title">Характеристики</h3>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Площадь дома (м²)</label>
                                {{ form.square(class="form-control", placeholder="120") }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Габариты (длина×ширина)</label>
                                {{ form.size(class="form-control", placeholder="15×7") }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Базовая цена</label>
                                <div class="price-input-group">
                                    {{ form.price_base(class="form-control", placeholder="0") }}
                                </div>
                                <small class="text-muted">Тёплый контур</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">С коммуникациями</label>
                                <div class="price-input-group">
                                    {{ form.price_with_communications(class="form-control", placeholder="0") }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Под ключ</label>
                                <div class="price-input-group">
                                    {{ form.price_ready(class="form-control", placeholder="0") }}
                                </div>
                            </div>
                            <div class="mb-0">
                                <label class="form-label fw-semibold">Ипотека в месяц</label>
                                <div class="price-input-group">
                                    {{ form.mortgage_price_per_month(class="form-control", placeholder="0") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Кнопка сохранения -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <a href="{{ url_for('admin.admin') }}" class="btn btn-outline-custom me-md-2">Отмена</a>
                            {{ form.submit(class="btn btn-primary-custom btn-lg px-4") }}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
    
<!-- СПИСОК ПРОЕКТОВ -->
<section id="projects" class="py-5 bg-light">
    <div class="container">
        <h2 class="section-title text-center mb-5">Существующие проекты</h2>
        {% include 'p2.html' %}
    </div>
</section>

{% endblock %}

<!-- PAGE LEVEL JS -->
{% block page_script %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        /* Проверка уникальности названия */
        const titleInput = document.querySelector("input[name='title']");
        const msg = document.getElementById("title-check-msg");
        let timer = null;
    
        if (titleInput) {
            titleInput.addEventListener("input", () => {
                clearTimeout(timer);
    
                timer = setTimeout(async () => {
                    const title = titleInput.value.trim();
                    if (!title) {
                        msg.textContent = "";
                        return;
                    }
    
                    const response = await fetch(`/check_title?title=${encodeURIComponent(title)}`);
                    const data = await response.json();
    
                    msg.innerHTML = data.exists
                        ? "<span class='text-danger'><i class='bi bi-exclamation-circle'></i> Проект с таким названием уже существует</span>"
                        : "<span class='text-success'><i class='bi bi-check-circle'></i> Название свободно</span>";
                }, 350);
            });
        }
    
        /* Удаление проекта */
        document.addEventListener("click", async (e) => {
            const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content'); 

            const btn = e.target.closest(".delete-project-btn");
            if (!btn) return;
    
            if (!confirm("Вы уверены, что хотите удалить этот проект?")) return;
    
            const id = btn.dataset.id;
            // const response = await fetch(`/api/project/${id}`, { method: "DELETE" });
            const response = await fetch(`/api/project/${id}`, {
                method: 'DELETE',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });

            if (response.ok) {
                btn.closest(".col-md-6.col-lg-4").remove();
            } else {
                alert("Ошибка удаления проекта");
            }
        });
    
        /* Загрузка файлов */
        const uploadArea = document.getElementById('uploadArea');
        const uploadInput = document.getElementById('imgUpload');
        const uploadTrigger = document.getElementById('uploadTrigger');
        const selectedFilesContainer = document.getElementById('selectedFiles');
        const fileList = document.getElementById('fileList');
        const clearFilesBtn = document.getElementById('clearFiles');
    
        // Открытие диалога выбора файлов при клике
        uploadArea.addEventListener('click', function(e) {
            if (e.target !== uploadTrigger && !uploadTrigger.contains(e.target)) {
                uploadInput.click();
            }
        });
    
        uploadTrigger.addEventListener('click', function(e) {
            e.stopPropagation();
            uploadInput.click();
        });
    
        // Перетаскивание файлов
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
    
        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('dragover');
        });
    
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
    
            if (e.dataTransfer.files.length) {
                uploadInput.files = e.dataTransfer.files;
                validateAndShowFiles();
            }
        });
    
        // Выбор файлов
        uploadInput.addEventListener('change', validateAndShowFiles);
    
        // Очистка списка выбранных файлов
        clearFilesBtn.addEventListener('click', function() {
            uploadInput.value = '';
            selectedFilesContainer.style.display = 'none';
            fileList.innerHTML = '';
        });
    
        function validateAndShowFiles() {
            const selectedFiles = Array.from(uploadInput.files);
    
            if (selectedFiles.length === 0) {
                selectedFilesContainer.style.display = 'none';
                return;
            }
    
            // Проверка дубликатов внутри загружаемых файлов
            const names = selectedFiles.map(f => f.name);
            const duplicatesInsideUpload = names.filter((name, index) =>
                names.indexOf(name) !== index
            );
    
            if (duplicatesInsideUpload.length > 0) {
                alert("Нельзя загружать два файла с одинаковыми именами:\n" +
                        duplicatesInsideUpload.join("\n"));
                uploadInput.value = "";
                selectedFilesContainer.style.display = 'none';
                return;
            }
    
            // Показываем список файлов
            fileList.innerHTML = '';
            selectedFiles.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-medium"><i class="bi bi-file-image text-primary me-2"></i>${file.name}</div>
                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
    
            selectedFilesContainer.style.display = 'block';
        }
    });
</script>
{% endblock %}

