{% extends 'base.html' %}
{% block title %}Admin{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_cards.css') }}">
<!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/style_edit_project.css') }}"> -->
{% endblock %}

{% block header %}
<div class="fixed-top">

  <!-- üîπ –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="topbar py-1 bg-secondary">
    <div class="container d-flex flex-wrap align-items-center justify-content-between">
      <div class="text-white">
        üìû <a href="tel:+79173755545" class="text-white text-decoration-none">+7 (917) 37-555-45</a>
      </div>

      <div class="d-flex gap-2">
        <a href="https://t.me/username" target="_blank" class="social-btn text-white" aria-label="Telegram">
          <i class="fab fa-telegram"></i>
        </a>
        <a href="https://vk.com/username" target="_blank" class="social-btn text-white" aria-label="VK">
          <i class="fab fa-vk"></i>
        </a>
      </div>
    </div>
  </div>

  <!-- üîπ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <nav class="navbar navbar-expand-md navbar-light bg-white border-bottom py-3" id="mainNav">
    <div class="container">

      <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
        <img src="{{ url_for('static', filename='images/logo_krepkii_fundament.png')}}" alt="Logo" width="300">
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="mainNavbar">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" href="#projects">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a></li>
        </ul>

        <div class="d-md-none text-center mt-3">
          <a href="tel:+79173755545" class="btn btn-outline-primary">üìû +7 (917) 37-555-45</a>
          <p class="text-secondary mb-0">–ü–Ω‚Äì–ü—Ç: —Å 9:00 –¥–æ 18:00</p>
        </div>
      </div>

    </div>
  </nav>

</div>
{% endblock %}

{% block hero %}{% endblock %}
{% block features %}{% endblock %}

{% block projects %}

<!-- ============================
       –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
============================= -->
<section class="py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold" style="font-family: 'Oswald', sans-serif;">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h2>
      <a href="{{ url_for('main.admin') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      </a>
    </div>
    
    <form method="POST" action="{{ url_for('main.add_project') }}" enctype="multipart/form-data">
      {{ form.hidden_tag() }}

      <div class="row g-4 align-items-start">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="col-lg-8">
          <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
              <h5 class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
              <div class="mb-4">
                <label class="form-label fw-bold">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                {{ form.title(class="form-control form-control-lg") }}
                <div id="title-check-msg" class="small mt-2"></div>
              </div>

              <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
              <div class="mb-0">
                <label class="form-label fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                {{ form.description(class="form-control", rows="5", placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞...") }}
              </div>
            </div>
          </div>
          
          <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
              <h5 class="section-title">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞</h5>
              
              <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
              <div class="mb-4">
                <label class="form-label fw-bold">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <div class="upload-area" id="uploadArea">
                  <div class="upload-icon">
                    <i class="bi bi-cloud-arrow-up"></i>
                  </div>
                  <p class="mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                  <!-- <p class="text-muted small">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã JPG, PNG, GIF. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</p> -->
                  
                  <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ñ–æ—Ä–º–µ -->
                  <div class="file-input-wrapper">
                    {{ form.img_files(multiple=True, id="imgUpload", class="form-control") }}
                    <button type="button" class="btn btn-outline-success mt-2" id="uploadTrigger">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                  </div>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
                <div class="selected-files" id="selectedFiles">
                  <h6 class="fw-bold mb-3">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</h6>
                  <div class="file-list" id="fileList"></div>
                  <button type="button" class="btn btn-outline-danger btn-sm mt-3" id="clearFiles">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                </div>
              </div>
              
              <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->

            </div>
          </div>
        </div>

        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
        <div class="col-lg-4">
          <div class="card border-0 shadow-sm characteristics-card">
            <div class="card-body">
              <h5 class="section-title">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h5>
              
              <div class="mb-3">
                <label class="form-label">–ü–ª–æ—â–∞–¥—å –¥–æ–º–∞ (–º¬≤)</label>
                {{ form.square(class="form-control", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 120") }}
              </div>

              <div class="mb-3">
                <label class="form-label">–ì–∞–±–∞—Ä–∏—Ç—ã: –¥–ª–∏–Ω–Ω–∞ —Ö —à–∏—Ä–∏–Ω–∞</label>
                {{ form.size(class="form-control", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15—Ö7") }}
              </div>
              
              <div class="mb-3">
                <label class="form-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (—Ç—ë–ø–ª—ã–π –∫–æ–Ω—Ç—É—Ä)</label>
                <div class="price-input-group">
                  {{ form.price_base(class="form-control", placeholder="0") }}
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">–¶–µ–Ω–∞ —Å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏</label>
                <div class="price-input-group">
                  {{ form.price_with_communications(class="form-control", placeholder="0") }}
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">–¶–µ–Ω–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –¥–æ–º–∞</label>
                <div class="price-input-group">
                  {{ form.price_ready(class="form-control", placeholder="0") }}
                </div>
              </div>

              <div class="mb-0">
                <label class="form-label">–ò–ø–æ—Ç–µ–∫–∞ (–≤ –º–µ—Å—è—Ü)</label>
                <div class="price-input-group">
                  {{ form.mortgage_price_per_month(class="form-control", placeholder="0") }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="d-grid gap-2 d-md-flex justify-content-md-start">
            <a href="{{ url_for('main.admin') }}" class="btn btn-outline-secondary me-md-2">–û—Ç–º–µ–Ω–∞</a>
            {{ form.submit(class="btn btn-success btn-lg px-4") }}
          </div>
        </div>
      </div>
    </form>
  </div>
</section>

<!-- ============================
          –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
============================= -->
<section id="projects" class="py-5 bg-light">
  <div class="container">

    <div class="row g-4">

      {% for project in projects %}
      <div class="col-md-6 col-lg-4">

        <a href="{{ url_for('main.edit_project', id=project.id) }}" class="text-decoration-none text-reset">
          <div class="card project-card border-0 shadow-sm h-100">

            <!-- –ö–∞—Ä—É—Å–µ–ª—å -->
            <div id="carousel{{ project.id }}" class="carousel slide">
              <div class="carousel-inner">
                {% for image in project.images.all() %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                  <img src="{{ url_for('static', filename=image.url) }}" class="card-img-top" alt="{{ project.title }}">
                </div>
                {% endfor %}
              </div>

              <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ project.id }}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ project.id }}" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>

            <div class="card-body p-4">
              <h5 class="fw-semibold mb-3">{{ project.title }}</h5>

              <table class="table table-borderless text-secondary small mb-0">
                <tbody>
                  <tr>
                    <th>–¢—ë–ø–ª—ã–π –∫–æ–Ω—Ç—É—Ä:</th>
                    <td class="text-end text-dark">{{ project.price_base | money }} ‚ÇΩ</td>
                  </tr>
                  <tr>
                    <th>–° –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º–∏:</th>
                    <td class="text-end text-dark">{{ project.price_with_communications | money }} ‚ÇΩ</td>
                  </tr>
                  <tr>
                    <th>–ì–æ—Ç–æ–≤—ã–π –¥–æ–º:</th>
                    <td class="text-end text-dark">{{ project.price_ready | money }} ‚ÇΩ</td>
                  </tr>
                  <tr class="border-top">
                    <th class="pt-2">–ò–ø–æ—Ç–µ–∫–∞:</th>
                    <td class="text-end fw-semibold pt-2">{{ project.mortgage_price_per_month | money }} ‚ÇΩ/–º–µ—Å</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </a>

        <button class="btn btn-danger btn-sm delete-btn mt-2" data-id="{{ project.id }}">DELETE</button>

      </div>
      {% endfor %}

    </div>
  </div>
</section>


<!-- ============================
               JS
============================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è */
  const titleInput = document.querySelector("input[name='title']");
  const msg = document.getElementById("title-check-msg");
  let timer = null;

  if (titleInput) {
    titleInput.addEventListener("input", () => {
      clearTimeout(timer);

      timer = setTimeout(async () => {
        const title = titleInput.value.trim();
        if (!title) {
          msg.textContent = "";
          return;
        }

        const response = await fetch(`/check_title?title=${encodeURIComponent(title)}`);
        const data = await response.json();

        msg.innerHTML = data.exists
          ? "<span class='text-danger'>–ü—Ä–æ–µ–∫—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>"
          : "<span class='text-success'>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ</span>";
      }, 350);
    });
  }

  /* –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ */
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".delete-btn");
    if (!btn) return;

    if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) return;

    const id = btn.dataset.id;
    const response = await fetch(`/api/project/${id}`, { method: "DELETE" });

    if (response.ok) {
      btn.closest(".col-md-6.col-lg-4").remove();
    } else {
      alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
    }
  });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const uploadInput = document.getElementById('imgUpload');
    const uploadTrigger = document.getElementById('uploadTrigger');
    const selectedFilesContainer = document.getElementById('selectedFiles');
    const fileList = document.getElementById('fileList');
    const clearFilesBtn = document.getElementById('clearFiles');

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ
    uploadArea.addEventListener('click', function(e) {
        if (e.target !== uploadTrigger && !uploadTrigger.contains(e.target)) {
            uploadInput.click();
        }
    });

    uploadTrigger.addEventListener('click', function(e) {
        e.stopPropagation();
        uploadInput.click();
    });

    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        if (e.dataTransfer.files.length) {
            uploadInput.files = e.dataTransfer.files;
            validateAndShowFiles();
        }
    });

    // –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤
    uploadInput.addEventListener('change', validateAndShowFiles);

    // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    clearFilesBtn.addEventListener('click', function() {
        uploadInput.value = '';
        selectedFilesContainer.style.display = 'none';
        fileList.innerHTML = '';
    });

    function validateAndShowFiles() {
        const selectedFiles = Array.from(uploadInput.files);

        if (selectedFiles.length === 0) {
            selectedFilesContainer.style.display = 'none';
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
        const names = selectedFiles.map(f => f.name);
        const duplicatesInsideUpload = names.filter((name, index) =>
            names.indexOf(name) !== index
        );

        if (duplicatesInsideUpload.length > 0) {
            alert("–ù–µ–ª—å–∑—è –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–≤–∞ —Ñ–∞–π–ª–∞ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏:\n" +
                  duplicatesInsideUpload.join("\n"));
            uploadInput.value = "";
            selectedFilesContainer.style.display = 'none';
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
        fileList.innerHTML = '';
        selectedFiles.forEach((file) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="flex-grow-1">
                    <div class="fw-medium">${file.name}</div>
                    <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
            `;
            fileList.appendChild(fileItem);
        });

        selectedFilesContainer.style.display = 'block';
    }
});
</script>


{% endblock %}
